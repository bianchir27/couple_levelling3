<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Couple Levelling: O Or√°culo da Rotina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            background-image: url('https://www.transparenttextures.com/patterns/dark-matter.png');
        }
        .font-cinzel { font-family: 'Cinzel', serif; }
        .card {
            background-color: rgba(42, 39, 39, 0.8);
            border: 1px solid #4a4a4a;
            backdrop-filter: blur(5px);
        }
        .btn { transition: all 0.2s ease-in-out; border: 1px solid #5a5a5a; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .btn-mission { background-color: #3a3a3a; }
        .btn-mission:hover { background-color: #4a4a4a; border-color: #7a7a7a; }
        .btn-veto { background-color: #6d28d9; border-color: #8b5cf6; }
        .btn-veto:disabled { background-color: #3730a3; border-color: #4f46e5; cursor: not-allowed; opacity: 0.5; }
        .ce-positive { color: #22c55e; text-shadow: 0 0 5px #22c55e; }
        .ce-negative { color: #ef4444; text-shadow: 0 0 5px #ef4444; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); }
        .tab-btn { padding: 0.5rem 1rem; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; position: relative; }
        .tab-btn.active { color: #facc15; border-bottom-color: #facc15; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .player-toggle-btn { border: 2px solid #4a4a4a; transition: all 0.3s; }
        .player-toggle-btn.active { background-color: #facc15; color: #1a1a1a; border-color: #facc15; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #22c55e; color: white; padding: 1rem 2rem; border-radius: 0.5rem; z-index: 1000; opacity: 0; transition: opacity 0.5s, transform 0.5s; }
        .toast.show { opacity: 1; transform: translate(-50%, -10px); }
        .toast.error { background-color: #ef4444; }
        .streak-card { background-color: rgba(255, 255, 255, 0.05); padding: 0.75rem; border-radius: 0.5rem; display: flex; align-items: center; justify-content: space-between; font-weight: bold; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #facc15; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .message-bubble { max-width: 75%; padding: 0.75rem; border-radius: 1rem; }
        .message-sent { background-color: #1e40af; border-bottom-right-radius: 0.25rem; }
        .message-received { background-color: #374151; border-bottom-left-radius: 0.25rem; }
        .notification-dot { position: absolute; top: 5px; right: 5px; width: 10px; height: 10px; background-color: #ef4444; border-radius: 50%; display: none; }
        .report-card { background: linear-gradient(145deg, #2d2d2d, #1a1a1a); border: 2px solid #facc15; box-shadow: 0 0 20px rgba(250, 204, 21, 0.3); }
        .report-stat { background-color: rgba(255,255,255,0.05); padding: 0.75rem; border-radius: 0.5rem; text-align: center; }
        .xp-bar-container { background-color: #374151; border-radius: 9999px; overflow: hidden; height: 10px; }
        .xp-bar { background-color: #facc15; height: 100%; transition: width 0.5s ease-in-out; }
        .trophy-card { opacity: 0.4; filter: grayscale(80%); transition: all 0.3s; }
        .trophy-card.unlocked { opacity: 1; filter: grayscale(0%); }
        .trophy-progress-bar-container { background-color: #4a4a4a; border-radius: 9999px; height: 8px; overflow: hidden; }
        .trophy-progress-bar { background-color: #facc15; height: 100%; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Tela de Carregamento / ID da Campanha -->
    <div id="loading-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-900 bg-opacity-90 backdrop-blur-sm">
        <div id="campaign-selector" class="card p-8 rounded-lg text-center">
            <h2 class="text-3xl font-cinzel text-yellow-300 mb-4">Or√°culo da Rotina</h2>
            <p class="mb-6 text-gray-400">Insira o ID da Campanha para sincronizar os dados.</p>
            <input type="text" id="campaign-id-input" placeholder="ID da Campanha" class="bg-gray-800 border border-gray-600 rounded-md p-2 w-full mb-4 text-center">
            <button id="join-campaign-btn" class="btn btn-mission bg-green-700 hover:bg-green-600 w-full mb-2 py-2">Entrar / Criar Campanha</button>
            <p class="text-xs text-gray-500">Crie um ID e compartilhe com o outro jogador.</p>
        </div>
        <div id="player-selector" class="card p-8 rounded-lg text-center hidden">
            <h2 class="text-2xl font-cinzel text-yellow-300 mb-4">Quem √© voc√™?</h2>
            <div id="player-selection-buttons" class="flex flex-col gap-4"></div>
        </div>
        <div id="loader-container" class="text-center hidden">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-lg font-cinzel">Sincronizando com o grim√≥rio...</p>
        </div>
    </div>

    <div id="app-container" class="container mx-auto max-w-7xl hidden">
        <header class="text-center mb-6">
            <h1 class="text-4xl md:text-6xl font-cinzel font-bold text-yellow-300" style="text-shadow: 0 0 10px #facc15, 0 0 20px #facc15;">Couple Levelling</h1>
            <p id="campaign-id-display" class="text-sm font-mono text-gray-500 mt-2 cursor-pointer" title="Clique para copiar"></p>
            <p id="viewing-player-display" class="text-sm text-gray-400 mt-1 cursor-pointer hover:text-yellow-300 transition" title="Clique para trocar de jogador"></p>
        </header>

        <nav class="flex justify-center border-b border-gray-700 mb-8 text-sm md:text-base">
            <button class="tab-btn active" data-tab="dashboard">Painel</button>
            <button class="tab-btn" data-tab="missions">Miss√µes</button>
            <button class="tab-btn" data-tab="trophies">Trof√©us</button>
            <button class="tab-btn" data-tab="messages">Recados <span id="message-notification-dot" class="notification-dot"></span></button>
            <button class="tab-btn" data-tab="logs">Registros</button>
            <button class="tab-btn" data-tab="settings">Configura√ß√µes</button>
        </nav>

        <main>
            <!-- Conte√∫do das abas -->
            <div id="dashboard" class="tab-content active">
                <section id="main-dashboard" class="card rounded-lg p-6 mb-8 grid grid-cols-1 md:grid-cols-3 gap-6 text-center shadow-lg">
                    <div id="player1-dashboard-card"></div>
                    <div class="border-t-2 md:border-t-0 md:border-x-2 border-gray-600 px-6">
                        <h2 class="text-2xl font-cinzel text-yellow-400">Tesouro da Sincronia</h2>
                        <p id="totalCE" class="text-2xl font-bold">Total: 0 CE</p>
                        <p id="treasureValue" class="text-5xl font-bold text-green-400" style="text-shadow: 0 0 8px #4ade80;">R$ 0,00</p>
                    </div>
                    <div id="player2-dashboard-card"></div>
                </section>

                <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="card rounded-lg p-6">
                        <h3 class="text-2xl font-cinzel text-center mb-4">Ofensivas de Miss√µes</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div id="player1-streaks"></div>
                            <div id="player2-streaks"></div>
                        </div>
                    </div>
                    <div class="card rounded-lg p-6">
                        <h3 class="text-2xl font-cinzel text-center mb-4">CE por Dia (√öltimos 7 Dias)</h3>
                        <div id="daily-score-table" class="overflow-x-auto"></div>
                    </div>
                </section>
                
                <section>
                    <h2 class="text-3xl font-cinzel text-center mb-4 text-yellow-300">Conquistas & Tesouros Raros</h2>
                    <div id="achievements-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                </section>
            </div>

            <div id="missions" class="tab-content">
                <div class="card rounded-lg p-6">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div class="flex-grow">
                            <label for="date-selector" class="font-cinzel text-yellow-400 mr-2">Data do Registro:</label>
                            <input type="date" id="date-selector" class="bg-gray-800 border border-gray-600 rounded-md p-2">
                        </div>
                        <div id="player-toggle" class="flex rounded-lg bg-gray-800 p-1"></div>
                    </div>
                    <div id="mission-list-container"></div>
                </div>
            </div>

            <div id="trophies" class="tab-content">
                <div class="card rounded-lg p-6">
                    <div class="flex justify-center mb-6">
                        <div id="trophy-player-toggle" class="flex rounded-lg bg-gray-800 p-1"></div>
                    </div>
                    <div id="trophy-list-container"></div>
                </div>
            </div>

            <div id="messages" class="tab-content">
                 <div class="card rounded-lg p-4 flex flex-col h-[70vh]">
                    <h2 class="text-3xl font-cinzel text-center mb-4 text-gray-400">Mural de Recados</h2>
                    <div id="message-list" class="flex-grow space-y-4 overflow-y-auto p-4"></div>
                    <div class="mt-4 flex gap-4 border-t border-gray-600 pt-4">
                        <textarea id="message-input" rows="1" placeholder="Escreva seu recado..." class="bg-gray-800 border border-gray-600 rounded-md p-2 w-full resize-none"></textarea>
                        <button id="send-message-btn" class="btn btn-mission bg-blue-700 hover:bg-blue-600 rounded-md px-6 py-2">Enviar</button>
                    </div>
                 </div>
            </div>

            <div id="logs" class="tab-content">
                <section>
                    <h2 class="text-3xl font-cinzel text-center mb-4 text-gray-400">Livro de Registros</h2>
                    <div id="activity-log" class="card rounded-lg p-4 h-[50vh] overflow-y-auto shadow-inner"></div>
                </section>
            </div>

            <div id="settings" class="tab-content">
                <section class="card rounded-lg p-6">
                    <h2 class="text-3xl font-cinzel text-center mb-6 text-gray-400">Altar da Maleabilidade</h2>
                    <div id="settings-form"></div>
                    <div class="mt-8 border-t border-gray-600 pt-6 text-center">
                         <h3 class="text-xl font-cinzel text-yellow-500 mb-4">Controles da Campanha</h3>
                         <div class="flex flex-col md:flex-row gap-4 justify-center">
                            <button id="changeCampaignBtn" class="btn btn-mission bg-yellow-700 hover:bg-yellow-600 border-yellow-500 text-white rounded-md px-6 py-2">Trocar Campanha</button>
                            <button id="exportCSV" class="btn btn-mission bg-blue-800 hover:bg-blue-700 border-blue-600 text-white rounded-md px-6 py-2">Exportar para CSV</button>
                            <button id="resetCycle" class="btn btn-mission bg-red-800 hover:bg-red-700 border-red-600 text-white rounded-md px-6 py-2">Iniciar Novo Ciclo Lunar</button>
                         </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modals e Toasts -->
    <div id="missionModal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="card rounded-lg p-8 z-10 w-11/12 md:w-1/3">
            <h3 id="modalTitle" class="text-2xl font-cinzel mb-4"></h3>
            <div id="modalBody"></div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="modalCancel" class="btn btn-mission rounded-md px-4 py-2">Cancelar</button>
                <button id="modalConfirm" class="btn btn-mission bg-green-700 hover:bg-green-600 border-green-500 rounded-md px-4 py-2">Confirmar</button>
            </div>
        </div>
    </div>
    <div id="confirmModal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="card rounded-lg p-8 z-10 w-11/12 md:w-1/3 text-center">
            <h3 id="confirmModalTitle" class="text-2xl font-cinzel mb-4">Confirmar A√ß√£o</h3>
            <p id="confirmModalBody" class="text-lg mb-6"></p>
            <div class="flex justify-center gap-4 mt-6">
                <button id="confirmModalCancel" class="btn btn-mission rounded-md px-6 py-2">Cancelar</button>
                <button id="confirmModalConfirm" class="btn btn-mission bg-green-700 hover:bg-green-600 border-green-500 rounded-md px-6 py-2">Confirmar</button>
            </div>
        </div>
    </div>
    <div id="cycleReportModal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="card report-card rounded-lg p-8 z-10 w-11/12 md:w-1/2 text-center">
            <h3 class="text-3xl font-cinzel mb-2 text-yellow-300">Fim do Ciclo Lunar!</h3>
            <p class="text-gray-400 mb-6">Aqui est√° o resumo da vossa jornada:</p>
            <div id="cycleReportBody" class="text-left space-y-4 mb-8"></div>
            <div class="flex justify-center gap-4 mt-6">
                <button id="closeReportModalBtn" class="btn btn-mission rounded-md px-6 py-2">Fechar</button>
                <button id="confirmResetBtn" class="btn btn-mission bg-red-700 hover:bg-red-600 border-red-500 rounded-md px-6 py-2">Confirmar e Iniciar Novo Ciclo</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBW-BnhPQ83tcORZk34d0O7zU0RM8dmrog",
            authDomain: "couple-levelling.firebaseapp.com",
            projectId: "couple-levelling",
            storageBucket: "couple-levelling.appspot.com",
            messagingSenderId: "388987681031",
            appId: "1:388987681031:web:aebd2253e0fbb4c85d2da2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- CONFIGURA√á√ÉO INICIAL DO JOGO ---
        const missionDefinitions = {
            main: [
                { id: 'gym', name: 'üèãÔ∏è A Forja do Corpo', description: 'Treino na academia.', type: 'options', options: [
                    { label: 'Treino em Casal', value: 25 }, { label: 'Treino Individual', value: 20 }, { label: 'Dia Livre', value: 0 }, { label: 'Faltou ao Treino', value: -40 }
                ], trackStreak: true},
                { id: 'study', name: 'üìö O Tomo do Saber', description: 'Sess√£o de estudos.', type: 'input', unit: 'horas', trackStreak: true },
                { id: 'chocolate', name: 'üç´ O Feiti√ßo Doceamargo', description: 'Resistir ou ceder √† tenta√ß√£o.', type: 'options', options: [
                    { label: 'Resisti √† Vontade', value: 6 }, { label: 'Dia Livre', value: 0 }, { label: 'Cedi √† Tenta√ß√£o', value: -40 }
                ], trackStreak: true }
            ],
            secondary: [
                { id: 'stairs', name: 'ü¶ø Stairway to Heaven', description: '20 min no simulador de escada.', value: 9, type: 'simple' },
                { id: 'weight', name: '‚öñÔ∏è A Maldi√ß√£o de Sobedesce', description: 'Resultado da pesagem semanal.', type: 'options', options: [
                    { label: 'Perdeu 2kg+', value: 100 }, { label: 'Ganhou 2kg+', value: -150 }
                ]},
                { id: 'skincare', name: '‚ú® Pelis Sedosos', description: 'Rotina di√°ria de skin care.', value: 1, type: 'simple' },
                { id: 'pills', name: 'ü©π P√≠lulas do Sucesso', description: 'Tomar todos os rem√©dios (hero√≠na).', value: 0.3, type: 'simple', player: 2 },
                { id: 'veggies', name: 'ü•ó O Elixir de Vidaplenus', description: 'Adicionar legumes/frutas/vegetais.', value: 0.6, type: 'simple' },
                { id: 'duolingo', name: 'ü¶â Legenduo', description: 'Realizar a ofensiva do Duolingo.', value: 0.1, type: 'simple' },
                { id: 'reading', name: 'üìñ Leitura por Prazer', description: 'Ler por 20+ minutos.', value: 6, type: 'simple' },
                { id: 'hobby', name: 'üí° Of√≠cio do S√°bio', description: '45+ min em hobby de aprendizado.', value: 9, type: 'simple' },
                { id: 'water', name: 'üíß B√™n√ß√£o da Hidrata√ß√£o', description: 'Beber 3 litros de √°gua.', value: 3, type: 'simple' },
                { id: 'healthy_meal', name: 'üç± Banquete Saud√°vel', description: 'Comer apenas o planejado.', value: 6, type: 'simple' },
                { id: 'sleep', name: 'üò¥ Repouso do Her√≥i', description: 'Dormir e acordar no hor√°rio.', value: 3, type: 'simple' },
                { id: 'clean', name: 'üßπ Ritual da Ordem', description: 'Ambiente principal organizado.', value: 6, type: 'simple' },
                { id: 'planning', name: 'üóìÔ∏è Or√°culo Semanal', description: 'Planejar a semana juntos.', value: 24, type: 'simple' }
            ]
        };
        const achievements = [
            { id: 'willpower', name: 'For√ßa de Vontade', reward: 75, requirement: '7 dias consecutivos de Academia.' },
            { id: 'healthy_month', name: 'M√™s Saud√°vel', reward: 100, requirement: 'Registro completo no Yazio e meta de calorias.' },
            { id: 'combo', name: 'Combo de H√°bitos', reward: 8, requirement: 'Completar 8+ miss√µes secund√°rias no mesmo dia.'},
            { id: 'gold_month', name: 'M√™s de Ouro', reward: 250, requirement: 'Terminar o m√™s com saldo positivo nos gastos.' }
        ];
        const trophyDefinitions = {
            training_days: {
                name: "Forja do Corpo",
                icon: "üèãÔ∏è",
                tiers: [
                    { req: 10, name: "Halter de Bronze", icon: "ü•â" },
                    { req: 15, name: "Anilha de Prata", icon: "ü•à" },
                    { req: 18, name: "Barra de Ouro", icon: "ü•á" },
                    { req: 22, name: "Corpo Div√¥nico", icon: "üèÜ" }
                ]
            },
            study_hours: {
                name: "Tomo do Saber",
                icon: "üìö",
                tiers: [
                    { req: 10, name: "Pena de Bronze", icon: "ü•â" },
                    { req: 20, name: "Tomo de Prata", icon: "ü•à" },
                    { req: 30, name: "Biblioteca de Ouro", icon: "ü•á" },
                    { req: 40, name: "Mente Div√¥nica", icon: "üèÜ" }
                ]
            },
            willpower_days: {
                name: "For√ßa de Vontade",
                icon: "üõ°Ô∏è",
                tiers: [
                    { req: 7, name: "Escudo de Bronze", icon: "ü•â" },
                    { req: 15, name: "Armadura de Prata", icon: "ü•à" },
                    { req: 21, name: "Fortaleza de Ouro", icon: "ü•á" },
                    { req: 28, name: "Vontade Div√¥nica", icon: "üèÜ" }
                ]
            }
        };

        // --- ESTADO DO JOGO ---
        let gameState = {};
        let activePlayer = 'player1'; // Para a aba de miss√µes
        let viewingPlayer = null; // Para identificar o usu√°rio atual
        let activeTrophyPlayer = 'player1'; // Para a aba de trof√©us
        let selectedDate = new Date();
        let campaignId = null;
        let unsubscribe;

        // --- ELEMENTOS DO DOM ---
        let DOM = {};

        function getDefaultGameState() {
            const missionSettings = {};
            const streaks = {};
            [...missionDefinitions.main, ...missionDefinitions.secondary].forEach(mission => {
                if (mission.type === 'simple') missionSettings[mission.id] = mission.value;
                else if (mission.type === 'options') missionSettings[mission.id] = mission.options.map(opt => opt.value);
                if (mission.trackStreak) {
                    streaks[mission.id] = { count: 0, lastCompletion: null };
                }
            });
            return {
                player1: { name: 'Her√≥i 1', ce: 0, xp: 0, level: 1, vetoUsed: false, streaks: JSON.parse(JSON.stringify(streaks)) },
                player2: { name: 'Hero√≠na 2', ce: 0, xp: 0, level: 1, vetoUsed: false, streaks: JSON.parse(JSON.stringify(streaks)) },
                log: [],
                messages: [],
                settings: { 
                    conversionRate: 4, 
                    xpConversionRate: 100,
                    missions: missionSettings,
                    titles: {
                        player1: { 1: "Iniciante", 3: "Meio Divo", 6: "Divo Divinho", 9: "Divo Div√¥nico", 12: "Soberano da Rotina" },
                        player2: { 1: "Iniciante", 3: "Meia Diva", 6: "Diva Divinha", 9: "Diva Div√¥nica", 12: "Soberana da Rotina" }
                    },
                    xpLevels: {
                        2: 3000, 3: 4500, 4: 6750, 5: 10125, 6: 15188, 7: 22781, 8: 34172, 9: 51258, 10: 76887, 11: 115330, 12: 172995
                    }
                }
            };
        }

        // --- FUN√á√ïES DE ESTADO E UI ---
        async function saveStateToFirebase() {
            if (!campaignId) return;
            try {
                const campaignRef = doc(db, "campaigns", campaignId);
                await setDoc(campaignRef, gameState);
            } catch (error) {
                console.error("Erro ao salvar no Firebase: ", error);
                showToast("Falha ao sincronizar com o grim√≥rio.", true);
            }
        }

        function updateUI() {
            if (!gameState || !gameState.player1) return;
            
            renderDashboardCards();
            
            const combinedCE = gameState.player1.ce + gameState.player2.ce;
            DOM.totalCE.textContent = `Total: ${parseFloat(combinedCE.toFixed(2))} CE`;
            const treasure = combinedCE > 0 ? combinedCE / gameState.settings.conversionRate : 0;
            DOM.treasureValue.textContent = `R$ ${treasure.toFixed(2).replace('.', ',')}`;

            renderLog();
            renderMissionsTab();
            renderStreaks();
            renderDailyScoreTable();
            renderAchievements();
            renderMessages();
            renderTrophies();
        }
        
        function renderLog() {
            DOM.activityLog.innerHTML = '';
            if (!gameState.log || gameState.log.length === 0) {
                DOM.activityLog.innerHTML = '<p class="text-gray-500 text-center">A jornada come√ßa agora...</p>';
            } else {
                [...gameState.log].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach((entry) => {
                    const p = document.createElement('div');
                    p.className = `flex justify-between items-center border-b border-gray-700 py-2 text-sm ${entry.ceChange >= 0 ? 'text-green-400' : 'text-red-400'}`;
                    const sign = entry.ceChange >= 0 ? '+' : '';
                    p.innerHTML = `
                        <div>
                            <span class="font-bold">${entry.playerName}</span>: ${entry.missionName} (<span class="font-semibold">${sign}${parseFloat(entry.ceChange.toFixed(2))} CE</span>)
                            <span class="block text-xs text-gray-500">${new Date(entry.timestamp).toLocaleString('pt-BR')}</span>
                        </div>
                        <button class="text-red-500 hover:text-red-300 font-bold text-xl px-2" onclick="window.deleteLogEntry('${entry.id}')">&times;</button>
                    `;
                    DOM.activityLog.appendChild(p);
                });
            }
        }

        function showToast(message, isError = false) {
            DOM.toast.textContent = message;
            DOM.toast.className = `toast show ${isError ? 'error' : ''}`;
            setTimeout(() => {
                DOM.toast.className = 'toast';
            }, 3000);
        }

        // --- FUN√á√ïES DE L√ìGICA DO JOGO ---

        function calculateXPForLevel(level) {
            if (level <= 1) return 0;
            return gameState.settings.xpLevels[level] || 999999;
        }

        function checkLevelUp(player) {
            let xpNeeded = calculateXPForLevel(gameState[player].level + 1);
            while (gameState[player].xp >= xpNeeded) {
                gameState[player].level++;
                gameState[player].xp -= xpNeeded;
                xpNeeded = calculateXPForLevel(gameState[player].level + 1);
                showToast(`${gameState[player].name} subiu para o N√≠vel ${gameState[player].level}!`);
            }
        }

        function recalculateLevels() {
            ['player1', 'player2'].forEach(player => {
                let totalXP = 0;
                gameState.log.forEach(entry => {
                    if (entry.player === player) {
                        totalXP += entry.ceChange * gameState.settings.xpConversionRate;
                    }
                });
                
                if(totalXP < 0) totalXP = 0;

                gameState[player].xp = 0;
                gameState[player].level = 1;
                let xpForLevelUp = calculateXPForLevel(2);
                while (totalXP >= xpForLevelUp) {
                    totalXP -= xpForLevelUp;
                    gameState[player].level++;
                    xpForLevelUp = calculateXPForLevel(gameState[player].level + 1);
                }
                gameState[player].xp = totalXP;
            });
        }

        function confirmAndAddCE(player, mission, ceChange, details = "") {
            const message = `Registrar <strong class="${ceChange >= 0 ? 'ce-positive' : 'ce-negative'}">${ceChange > 0 ? '+' : ''}${ceChange} CE</strong> para a miss√£o "${mission.name}"?`;
            showConfirmation(message, () => {
                addCE(player, mission, `${mission.name} ${details}`, ceChange);
            });
        }

        function addCE(player, mission, missionName, ceChange) {
            const playerName = gameState[player].name;
            gameState[player].ce += ceChange;
            
            const xpChange = ceChange * gameState.settings.xpConversionRate;
            gameState[player].xp += xpChange;
            if (gameState[player].xp < 0) gameState[player].xp = 0;
            checkLevelUp(player);

            gameState.log.push({ id: crypto.randomUUID(), player, playerName, missionName, ceChange, timestamp: selectedDate.toISOString() });
            
            if (mission.trackStreak) {
                recalculateStreaks();
            }
            saveStateToFirebase();
        }

        window.deleteLogEntry = function(entryId) {
            showConfirmation("Tem certeza que deseja apagar este registro? A a√ß√£o n√£o pode ser desfeita.", () => {
                const entryIndex = gameState.log.findIndex(e => e.id === entryId);
                if (entryIndex > -1) {
                    const entry = gameState.log[entryIndex];
                    gameState[entry.player].ce -= entry.ceChange;
                    gameState.log.splice(entryIndex, 1);
                    recalculateLevels();
                    recalculateStreaks();
                    showToast("Registro apagado com sucesso.");
                    saveStateToFirebase();
                }
            });
        }

        function getMissionValue(missionId, optionIndex = null) {
            const mission = [...missionDefinitions.main, ...missionDefinitions.secondary].find(m => m.id === missionId);
            if (!mission) return 0;
            const setting = gameState.settings.missions[missionId];
            if (mission.type === 'simple') return setting;
            if (mission.type === 'options' && optionIndex !== null) return setting[optionIndex];
            return 0;
        }

        function handleMissionClick(mission, player) {
            if (mission.type === 'simple') {
                confirmAndAddCE(player, mission, getMissionValue(mission.id));
            } else {
                openModal(mission, player);
            }
        }

        function openModal(mission, player) {
            const modal = DOM.missionModal;
            modal.title.textContent = mission.name;
            modal.body.innerHTML = '';

            if (mission.type === 'options') {
                mission.options.forEach((opt, index) => {
                    const value = getMissionValue(mission.id, index);
                    modal.body.innerHTML += `
                        <label class="flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer">
                            <input type="radio" name="missionOption" value="${value}" data-label="${opt.label}" class="mr-3" ${index === 0 ? 'checked' : ''}>
                            <span>${opt.label} (${value > 0 ? '+' : ''}${value} CE)</span>
                        </label>`;
                });
            } else if (mission.type === 'input') {
                modal.body.innerHTML = `
                    <label class="block text-sm text-gray-400 mb-2">Informe a quantidade (${mission.unit}):</label>
                    <input type="number" id="modalInput" class="bg-gray-800 border border-gray-600 rounded-md p-2 w-full" step="0.5" value="1">`;
            }

            modal.el.classList.remove('hidden');
            modal.el.classList.add('flex');

            modal.confirmBtn.onclick = () => {
                if (mission.type === 'options') {
                    const selectedRadio = document.querySelector('input[name="missionOption"]:checked');
                    const selectedValue = parseFloat(selectedRadio.value);
                    const details = `(${selectedRadio.dataset.label})`;
                    confirmAndAddCE(player, mission, selectedValue, details);
                } else if (mission.type === 'input') {
                    const inputValue = parseFloat(document.getElementById('modalInput').value);
                    if (isNaN(inputValue)) return;
                    if (mission.id === 'study') {
                        let ceChange = 0;
                        if (inputValue >= 1) ceChange = (inputValue - 1) * 20;
                        else if (inputValue < 1 && inputValue >= 0) ceChange = -30;
                        confirmAndAddCE(player, mission, ceChange, `(${inputValue}h)`);
                    }
                }
                closeModal(modal.el);
            };
        }

        function showConfirmation(message, onConfirmCallback) {
            const modal = DOM.confirmModal;
            modal.body.innerHTML = message;
            modal.el.classList.remove('hidden');
            modal.el.classList.add('flex');
            
            modal.confirmBtn.onclick = () => {
                onConfirmCallback();
                closeModal(modal.el);
            };
        }

        function closeModal(modalElement) {
            modalElement.classList.add('hidden');
            modalElement.classList.remove('flex');
        }

        function useVeto(player) {
            if (gameState[player].vetoUsed) return;
            const lastNegativeLogIndex = gameState.log.map((l, i) => (l.player === player && l.ceChange < 0) ? i : -1).filter(i => i !== -1).pop();
            
            if (lastNegativeLogIndex !== undefined) {
                const logEntry = gameState.log[lastNegativeLogIndex];
                const message = `Usar a Carta Veto para anular a penalidade de ${logEntry.ceChange} CE da miss√£o "${logEntry.missionName}"?`;
                showConfirmation(message, () => {
                    const reversedCE = -logEntry.ceChange;
                    gameState[player].ce += reversedCE;
                    gameState[player].vetoUsed = true;
                    addCE(player, {trackStreak: false}, `üìú Carta Veto usada em "${logEntry.missionName}"`, reversedCE);
                    showToast("Carta Veto usada com sucesso!");
                });
            } else {
                showToast("Nenhuma penalidade encontrada para anular.", true);
            }
        }
        
        function getSaoPauloDate(date) {
            const offset = -3; // UTC-3 for Bras√≠lia time
            const localDate = new Date(date.getTime() + (offset * 3600 * 1000));
            return localDate;
        }

        function getDayDiff(date1, date2) {
            const d1 = new Date(date1.getFullYear(), date1.getMonth(), date1.getDate());
            const d2 = new Date(date2.getFullYear(), date2.getMonth(), date2.getDate());
            return Math.round((d1 - d2) / (1000 * 60 * 60 * 24));
        }

        function recalculateStreaks() {
            ['player1', 'player2'].forEach(player => {
                const trackableMissions = missionDefinitions.main.filter(m => m.trackStreak);
                
                trackableMissions.forEach(mission => {
                    const missionLogs = gameState.log.filter(l => 
                        l.player === player && 
                        l.missionName.startsWith(mission.name.split(' ')[0])
                    );

                    if (missionLogs.length === 0) {
                        gameState[player].streaks[mission.id].count = 0;
                        return;
                    }

                    const dailyLogs = {};
                    missionLogs.forEach(l => {
                        const dateStr = new Date(l.timestamp).toLocaleDateString('sv-SE');
                        if (!dailyLogs[dateStr]) dailyLogs[dateStr] = [];
                        dailyLogs[dateStr].push(l);
                    });

                    const sortedDates = Object.keys(dailyLogs).sort();
                    
                    let currentStreak = 0;
                    let lastStreakDate = null;

                    for (let i = sortedDates.length - 1; i >= 0; i--) {
                        const dateStr = sortedDates[i];
                        const dayLogs = dailyLogs[dateStr];
                        
                        const wasSuccessful = dayLogs.some(l => {
                            if (mission.id === 'study') return l.ceChange >= 0;
                            return l.ceChange > 0 || l.missionName.includes('(Dia Livre)');
                        });

                        if (wasSuccessful) {
                            const currentDate = new Date(dateStr + 'T12:00:00Z');
                            if (lastStreakDate === null) {
                                currentStreak = 1;
                            } else if (getDayDiff(lastStreakDate, currentDate) === 1) {
                                currentStreak++;
                            } else {
                                break;
                            }
                            lastStreakDate = currentDate;
                        } else {
                            break;
                        }
                    }

                    const today = getSaoPauloDate(new Date());
                    if (lastStreakDate && getDayDiff(today, lastStreakDate) > 1) {
                        currentStreak = 0;
                    }

                    gameState[player].streaks[mission.id].count = currentStreak;
                });
            });
        }

        // --- FUN√á√ïES DE RENDERIZA√á√ÉO ---

        function getTitleForLevel(player, level) {
            const titles = gameState.settings.titles[player];
            let currentTitle = titles[1];
            for (const levelKey in titles) {
                if (level >= parseInt(levelKey)) {
                    currentTitle = titles[levelKey];
                }
            }
            return currentTitle;
        }

        function renderDashboardCards() {
            ['player1', 'player2'].forEach(p => {
                const player = gameState[p];
                const card = document.getElementById(`${p}-dashboard-card`);
                const color = p === 'player1' ? 'blue' : 'red';
                const xpForNext = calculateXPForLevel(player.level + 1);
                const xpProgress = xpForNext > 0 ? (player.xp / xpForNext) * 100 : 100;

                card.innerHTML = `
                    <div class="flex justify-center items-center gap-4">
                        <h2 class="text-2xl font-cinzel text-${color}-400">${player.name}</h2>
                        <span class="text-lg font-bold bg-gray-700 px-2 py-1 rounded">Nvl ${player.level}</span>
                    </div>
                    <p class="font-cinzel text-yellow-400 text-sm h-5">${getTitleForLevel(p, player.level)}</p>
                    <p class="text-4xl font-bold ${player.ce >= 0 ? 'ce-positive' : 'ce-negative'}">${player.ce.toFixed(2)} CE</p>
                    <div class="mt-2">
                        <div class="xp-bar-container">
                            <div class="xp-bar" style="width: ${xpProgress}%"></div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">${Math.floor(player.xp)} / ${xpForNext} XP</p>
                    </div>
                    <button id="veto${p.charAt(0).toUpperCase() + p.slice(1)}" class="btn btn-veto rounded-md px-4 py-2 mt-2 text-sm w-full" ${player.vetoUsed ? 'disabled' : ''}>Usar Carta Veto</button>
                `;
                card.querySelector('button').addEventListener('click', () => useVeto(p));
            });
        }

        function renderMissionsTab() {
            DOM.playerToggle.innerHTML = '';
            ['player1', 'player2'].forEach(p => {
                const btn = document.createElement('button');
                btn.textContent = gameState[p].name;
                btn.className = `player-toggle-btn px-4 py-2 rounded-md ${activePlayer === p ? 'active' : ''}`;
                btn.onclick = () => {
                    activePlayer = p;
                    renderMissionsTab();
                };
                DOM.playerToggle.appendChild(btn);
            });
            renderMissionListForPlayer(activePlayer);
        }

        function renderMissionListForPlayer(player) {
            const container = DOM.missionListContainer;
            container.innerHTML = '';

            const createList = (title, missions) => {
                const section = document.createElement('div');
                const titleEl = document.createElement('h3');
                titleEl.className = 'text-xl font-cinzel text-yellow-500 mt-6 mb-3';
                titleEl.textContent = title;
                section.appendChild(titleEl);

                const list = document.createElement('div');
                list.className = 'space-y-2';
                missions.forEach(m => {
                    if (m.player && m.player !== (player === 'player1' ? 1 : 2)) return;
                    const item = document.createElement('div');
                    item.className = 'bg-gray-800 p-3 rounded-lg flex justify-between items-center';
                    item.innerHTML = `
                        <div>
                            <p class="font-bold">${m.name}</p>
                            <p class="text-sm text-gray-400">${m.description}</p>
                        </div>
                        <button class="btn btn-mission rounded-md px-4 py-2 ml-4 flex-shrink-0">Registrar</button>
                    `;
                    item.querySelector('button').onclick = () => handleMissionClick(m, player);
                    list.appendChild(item);
                });
                section.appendChild(list);
                return section;
            };
            
            container.appendChild(createList('Miss√µes Principais', missionDefinitions.main));
            container.appendChild(createList('Miss√µes Secund√°rias', missionDefinitions.secondary));
        }

        function renderAchievements() {
            if (!DOM.achievementsSection) return;
            DOM.achievementsSection.innerHTML = '';
            achievements.forEach(ach => {
                const card = document.createElement('div');
                card.className = 'card rounded-lg p-4 text-center';
                card.innerHTML = `
                    <h4 class="text-lg font-bold font-cinzel text-yellow-200">${ach.name}</h4>
                    <p class="text-sm text-gray-400">${ach.requirement}</p>
                    <p class="text-xl font-bold ce-positive mt-2">+${ach.reward} CE</p>
                    <button class="btn btn-mission rounded-md px-4 py-2 mt-3 w-full text-sm">Resgatar</button>
                `;
                card.querySelector('button').onclick = () => claimAchievement(ach);
                DOM.achievementsSection.appendChild(card);
            });
        }

        function claimAchievement(achievement) {
            if (!viewingPlayer) return showToast("Erro: Jogador n√£o identificado.", true);
            const playerId = viewingPlayer;
            confirmAndAddCE(playerId, { name: achievement.name, trackStreak: false }, achievement.reward);
        }

        function renderStreaks() {
            const renderPlayerStreaks = (player, container) => {
                container.innerHTML = `<h4 class="text-lg font-cinzel text-center mb-2 ${player === 'player1' ? 'text-blue-400' : 'text-red-400'}">${gameState[player].name}</h4>`;
                const streaksGrid = document.createElement('div');
                streaksGrid.className = 'space-y-2';
                
                const trackableMissions = missionDefinitions.main.filter(m => m.trackStreak);
                
                trackableMissions.forEach(mission => {
                    const streak = gameState[player].streaks[mission.id];
                    const card = document.createElement('div');
                    card.className = 'streak-card';
                    card.innerHTML = `
                        <span>${mission.name.split(' ')[0]}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-xl">${streak?.count || 0}</span>
                            <span class="text-orange-400">${(streak?.count || 0) > 0 ? 'üî•' : '‚ùÑÔ∏è'}</span>
                        </div>
                    `;
                    streaksGrid.appendChild(card);
                });
                container.appendChild(streaksGrid);
            };
            renderPlayerStreaks('player1', DOM.player1Streaks);
            renderPlayerStreaks('player2', DOM.player2Streaks);
        }

        function renderDailyScoreTable() {
            const today = new Date();
            let tableHTML = `<table class="w-full text-center text-sm"><thead><tr class="border-b border-gray-600">
                <th class="py-2">Dia</th>
                <th class="py-2 text-blue-400">${gameState.player1.name}</th>
                <th class="py-2 text-red-400">${gameState.player2.name}</th>
            </tr></thead><tbody>`;

            const dailyScores = {};

            for (let i = 6; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const dateString = d.toISOString().split('T')[0];
                dailyScores[dateString] = { p1: 0, p2: 0, label: d.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit' }) };
            }

            gameState.log.forEach(entry => {
                const dateString = entry.timestamp.split('T')[0];
                if (dailyScores[dateString]) {
                    if (entry.player === 'player1') dailyScores[dateString].p1 += entry.ceChange;
                    else dailyScores[dateString].p2 += entry.ceChange;
                }
            });

            for (const dateString in dailyScores) {
                const scores = dailyScores[dateString];
                tableHTML += `<tr class="border-b border-gray-700">
                    <td class="py-2">${scores.label}</td>
                    <td class="py-2 font-bold ${scores.p1 > 0 ? 'ce-positive' : scores.p1 < 0 ? 'ce-negative' : ''}">${scores.p1.toFixed(1)}</td>
                    <td class="py-2 font-bold ${scores.p2 > 0 ? 'ce-positive' : scores.p2 < 0 ? 'ce-negative' : ''}">${scores.p2.toFixed(1)}</td>
                </tr>`;
            }

            tableHTML += '</tbody></table>';
            DOM.dailyScoreTable.innerHTML = tableHTML;
        }
        
        function renderTrophies() {
            DOM.trophyPlayerToggle.innerHTML = '';
            ['player1', 'player2'].forEach(p => {
                const btn = document.createElement('button');
                btn.textContent = gameState[p].name;
                btn.className = `player-toggle-btn px-4 py-2 rounded-md ${activeTrophyPlayer === p ? 'active' : ''}`;
                btn.onclick = () => {
                    activeTrophyPlayer = p;
                    renderTrophies();
                };
                DOM.trophyPlayerToggle.appendChild(btn);
            });
            renderTrophyListForPlayer(activeTrophyPlayer);
        }

        function renderTrophyListForPlayer(player) {
            const container = DOM.trophyListContainer;
            container.innerHTML = '';

            const stats = {
                training_days: new Set(gameState.log.filter(e => e.player === player && e.missionName.startsWith('üèãÔ∏è A Forja do Corpo') && e.ceChange > 0).map(e => e.timestamp.split('T')[0])).size,
                study_hours: gameState.log.filter(e => e.player === player && e.missionName.startsWith('üìö O Tomo do Saber')).reduce((sum, e) => {
                    const match = e.missionName.match(/\((\d+\.?\d*)h\)/);
                    return sum + (match ? parseFloat(match[1]) : 0);
                }, 0),
                willpower_days: (() => {
                    if (gameState.log.length === 0) return 0;
                    const cycleStart = new Date(gameState.log.reduce((min, l) => new Date(l.timestamp) < min ? new Date(l.timestamp) : min, new Date()));
                    const cycleEnd = new Date();
                    const cycleDuration = getDayDiff(cycleEnd, cycleStart) + 1;
                    const sweetDays = new Set(gameState.log.filter(e => e.player === player && e.missionName.startsWith('üç´ O Feiti√ßo Doceamargo') && e.ceChange < 0).map(e => e.timestamp.split('T')[0])).size;
                    return cycleDuration - sweetDays;
                })()
            };

            for (const key in trophyDefinitions) {
                const trophy = trophyDefinitions[key];
                const playerProgress = stats[key];

                const section = document.createElement('div');
                section.className = 'mb-8';
                section.innerHTML = `<h3 class="text-2xl font-cinzel text-yellow-500 mb-4">${trophy.icon} ${trophy.name}</h3>`;

                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4';

                trophy.tiers.forEach(tier => {
                    const unlocked = playerProgress >= tier.req;
                    const progressPercent = Math.min((playerProgress / tier.req) * 100, 100);
                    const card = document.createElement('div');
                    card.className = `card trophy-card p-4 text-center ${unlocked ? 'unlocked' : ''}`;
                    card.innerHTML = `
                        <div class="text-5xl">${tier.icon}</div>
                        <p class="font-bold mt-2">${tier.name}</p>
                        <p class="text-sm text-gray-400">${playerProgress.toFixed(1)} / ${tier.req}</p>
                        <div class="trophy-progress-bar-container mt-2">
                            <div class="trophy-progress-bar" style="width: ${progressPercent}%"></div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                section.appendChild(grid);
                container.appendChild(section);
            }
        }

        function renderSettings() {
            const form = DOM.settingsForm;
            form.innerHTML = '';
            
            let generalHTML = `<h3 class="text-xl font-cinzel text-yellow-500 mb-4">Jogadores & Convers√£o</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 items-end mb-6">
                    <label class="block"><span class="text-gray-300">Nome do Her√≥i 1</span><input type="text" id="player1Name" value="${gameState.player1.name}" class="mt-1 bg-gray-800 border border-gray-600 rounded-md p-2 w-full"></label>
                    <label class="block"><span class="text-gray-300">Nome da Hero√≠na 2</span><input type="text" id="player2Name" value="${gameState.player2.name}" class="mt-1 bg-gray-800 border border-gray-600 rounded-md p-2 w-full"></label>
                    <label class="block"><span class="text-gray-300">Taxa de Convers√£o (CE para R$ 1,00)</span><input type="number" id="conversionRate" value="${gameState.settings.conversionRate}" class="mt-1 bg-gray-800 border border-gray-600 rounded-md p-2 w-full"></label>
                    <label class="block"><span class="text-gray-300">Taxa de Convers√£o (CE para XP)</span><input type="number" id="xpConversionRate" value="${gameState.settings.xpConversionRate}" class="mt-1 bg-gray-800 border border-gray-600 rounded-md p-2 w-full"></label>
                </div>`;
            
            let titlesHTML = '<h3 class="text-xl font-cinzel text-yellow-500 mb-4 border-t border-gray-600 pt-4">T√≠tulos dos Jogadores</h3>';
            ['player1', 'player2'].forEach(p => {
                titlesHTML += `<div class="mb-4"><p class="font-bold mb-2">${gameState[p].name}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                for (const level in gameState.settings.titles[p]) {
                    titlesHTML += `<label class="block"><span class="text-sm text-gray-400">N√≠vel ${level}</span><input type="text" data-player="${p}" data-level="${level}" value="${gameState.settings.titles[p][level]}" class="mt-1 bg-gray-800 border border-gray-600 rounded-md p-2 w-full"></label>`;
                }
                titlesHTML += `</div></div>`;
            });

            let xpLevelsHTML = '<h3 class="text-xl font-cinzel text-yellow-500 mb-4 border-t border-gray-600 pt-4">Curva de Experi√™ncia</h3>';
            xpLevelsHTML += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
            for (const level in gameState.settings.xpLevels) {
                xpLevelsHTML += `<label class="block"><span class="text-sm text-gray-400">XP para N√≠vel ${level}</span><input type="number" data-level="${level}" value="${gameState.settings.xpLevels[level]}" class="mt-1 bg-gray-800 border border-gray-600 rounded-md p-2 w-full"></label>`;
            }
            xpLevelsHTML += '</div>';

            let missionsHTML = '<h3 class="text-xl font-cinzel text-yellow-500 mb-4 border-t border-gray-600 pt-4">Valores das Miss√µes</h3>';
            [...missionDefinitions.main, ...missionDefinitions.secondary].forEach(mission => {
                missionsHTML += `<div class="mb-4 p-2 border-b border-gray-700"><p class="font-bold">${mission.name}</p>`;
                if (mission.type === 'simple') {
                    missionsHTML += `<div class="flex items-center gap-4"><label class="text-sm text-gray-400">Valor em CE:</label><input type="number" data-mission-id="${mission.id}" value="${getMissionValue(mission.id)}" class="bg-gray-800 border border-gray-600 rounded-md p-1 w-24"></div>`;
                } else if (mission.type === 'options') {
                    mission.options.forEach((opt, index) => {
                        missionsHTML += `<div class="flex items-center gap-4 mt-1"><label class="text-sm text-gray-400 w-32">${opt.label}:</label><input type="number" data-mission-id="${mission.id}" data-option-index="${index}" value="${getMissionValue(mission.id, index)}" class="bg-gray-800 border border-gray-600 rounded-md p-1 w-24"></div>`;
                    });
                }
                missionsHTML += `</div>`;
            });

            form.innerHTML = generalHTML + titlesHTML + xpLevelsHTML + missionsHTML;
            addSettingsListeners();
        }

        function addSettingsListeners() {
            const updateSetting = (key, value) => {
                const keys = key.split('.');
                let obj = gameState;
                for (let i = 0; i < keys.length - 1; i++) {
                    obj = obj[keys[i]];
                }
                obj[keys[keys.length - 1]] = value;
                saveStateToFirebase();
            };

            document.getElementById('conversionRate').addEventListener('change', e => updateSetting('settings.conversionRate', parseFloat(e.target.value) || 3));
            document.getElementById('xpConversionRate').addEventListener('change', e => updateSetting('settings.xpConversionRate', parseFloat(e.target.value) || 100));
            document.getElementById('player1Name').addEventListener('change', e => updateSetting('player1.name', e.target.value));
            document.getElementById('player2Name').addEventListener('change', e => updateSetting('player2.name', e.target.value));

            document.querySelectorAll('#settings-form input[data-player]').forEach(input => {
                input.addEventListener('change', e => {
                    const { player, level } = e.target.dataset;
                    gameState.settings.titles[player][level] = e.target.value;
                    saveStateToFirebase();
                    showToast("T√≠tulo atualizado!");
                });
            });

            document.querySelectorAll('#settings-form input[data-level]').forEach(input => {
                input.addEventListener('change', e => {
                    const { level } = e.target.dataset;
                    gameState.settings.xpLevels[level] = parseInt(e.target.value, 10);
                    saveStateToFirebase();
                    showToast("Curva de XP atualizada!");
                });
            });

            document.querySelectorAll('#settings-form input[data-mission-id]').forEach(input => {
                input.addEventListener('change', e => {
                    const { missionId, optionIndex } = e.target.dataset;
                    const value = parseFloat(e.target.value);
                    if (optionIndex !== undefined) {
                        gameState.settings.missions[missionId][parseInt(optionIndex)] = value;
                    } else {
                        gameState.settings.missions[missionId] = value;
                    }
                    saveStateToFirebase();
                    showToast("Valor da miss√£o atualizado!");
                });
            });
        }

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Resumo da Campanha\r\n";
            csvContent += `Jogador 1,${gameState.player1.name},${gameState.player1.ce.toFixed(2)} CE\r\n`;
            csvContent += `Jogador 2,${gameState.player2.name},${gameState.player2.ce.toFixed(2)} CE\r\n`;
            const combinedCE = gameState.player1.ce + gameState.player2.ce;
            const treasure = combinedCE > 0 ? combinedCE / gameState.settings.conversionRate : 0;
            csvContent += `Tesouro Total,"R$ ${treasure.toFixed(2)}"\r\n\r\n`;
            csvContent += "Timestamp,Jogador,Miss√£o,Altera√ß√£o CE\r\n";
            gameState.log.forEach(entry => {
                const row = [ new Date(entry.timestamp).toLocaleString('pt-BR'), entry.playerName, `"${entry.missionName.replace(/"/g, '""')}"`, entry.ceChange.toFixed(2) ].join(',');
                csvContent += row + "\r\n";
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "couple_levelling_log.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function joinCampaign(id) {
            campaignId = id;
            localStorage.setItem('coupleLevellingCampaignId', id);
            DOM.campaignSelector.classList.add('hidden');
            DOM.loaderContainer.classList.remove('hidden');

            const campaignRef = doc(db, "campaigns", campaignId);
            
            if(unsubscribe) unsubscribe();

            unsubscribe = onSnapshot(campaignRef, (doc) => {
                const defaultState = getDefaultGameState();
                if (doc.exists()) {
                    const data = doc.data();
                    gameState = { ...defaultState, ...data,
                        player1: {...defaultState.player1, ...data.player1, streaks: {...defaultState.player1.streaks, ...(data.player1?.streaks || {})}},
                        player2: {...defaultState.player2, ...data.player2, streaks: {...defaultState.player2.streaks, ...(data.player2?.streaks || {})}},
                        settings: {...defaultState.settings, ...data.settings,
                            titles: {...defaultState.settings.titles, ...(data.settings?.titles || {})},
                            xpLevels: {...defaultState.settings.xpLevels, ...(data.settings?.xpLevels || {})}
                        }
                    };
                } else {
                    showToast("Campanha n√£o encontrada. Criando uma nova...");
                    gameState = defaultState;
                    saveStateToFirebase();
                }
                
                viewingPlayer = localStorage.getItem(`viewerId_${campaignId}`);
                if (!viewingPlayer) {
                    promptForPlayerSelection();
                } else {
                    finishLoading();
                }

            }, (error) => {
                console.error("Erro ao conectar com o Firebase: ", error);
                alert("Erro de conex√£o! Verifique se as regras do Firestore est√£o corretas e se a configura√ß√£o do Firebase est√° no c√≥digo.");
                DOM.loaderContainer.classList.add('hidden');
                DOM.campaignSelector.classList.remove('hidden');
            });
        }
        
        function promptForPlayerSelection() {
            DOM.loaderContainer.classList.add('hidden');
            DOM.playerSelector.classList.remove('hidden');
            DOM.playerSelectionButtons.innerHTML = '';
            
            ['player1', 'player2'].forEach(pId => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-mission py-2';
                btn.textContent = `Eu sou ${gameState[pId].name}`;
                btn.onclick = () => {
                    viewingPlayer = pId;
                    localStorage.setItem(`viewerId_${campaignId}`, pId);
                    DOM.playerSelector.classList.add('hidden');
                    finishLoading();
                };
                DOM.playerSelectionButtons.appendChild(btn);
            });
        }

        function finishLoading() {
            recalculateStreaks();
            checkForNewMessages();
            renderSettings();
            updateUI();
            DOM.loadingScreen.classList.add('hidden');
            DOM.appContainer.classList.remove('hidden');
            DOM.campaignIdDisplay.textContent = `ID da Campanha: ${campaignId}`;
            DOM.viewingPlayerDisplay.textContent = `Visualizando como: ${gameState[viewingPlayer].name}`;
        }

        function renderMessages() {
            DOM.messageList.innerHTML = '';
            if (!gameState.messages || gameState.messages.length === 0) {
                DOM.messageList.innerHTML = '<p class="text-gray-500 text-center">Nenhum recado ainda.</p>';
                return;
            }

            gameState.messages.forEach(msg => {
                const isSentByMe = msg.senderId === viewingPlayer;
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `flex ${isSentByMe ? 'justify-end' : 'justify-start'}`;
                
                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${isSentByMe ? 'message-sent' : 'message-received'}`;
                bubble.innerHTML = `
                    <p class="font-bold text-sm ${isSentByMe ? 'text-blue-300' : 'text-yellow-300'}">${msg.senderName}</p>
                    <p class="text-white">${msg.text}</p>
                    <p class="text-xs text-gray-400 text-right mt-1">${new Date(msg.timestamp).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</p>
                `;
                messageWrapper.appendChild(bubble);
                DOM.messageList.appendChild(messageWrapper);
            });
            DOM.messageList.scrollTop = DOM.messageList.scrollHeight;
        }

        function sendMessage() {
            const text = DOM.messageInput.value.trim();
            if (text === '' || !viewingPlayer) return;

            const newMessage = {
                id: crypto.randomUUID(),
                senderId: viewingPlayer,
                senderName: gameState[viewingPlayer].name,
                text: text,
                timestamp: new Date().toISOString()
            };

            if (!gameState.messages) {
                gameState.messages = [];
            }
            gameState.messages.push(newMessage);
            saveStateToFirebase();
            DOM.messageInput.value = '';
        }

        function checkForNewMessages() {
            if (!viewingPlayer || !gameState.messages || gameState.messages.length === 0) {
                DOM.messageNotificationDot.style.display = 'none';
                return;
            }

            const lastMessage = gameState.messages[gameState.messages.length - 1];
            
            if (lastMessage.senderId !== viewingPlayer) {
                DOM.messageNotificationDot.style.display = 'block';
            } else {
                DOM.messageNotificationDot.style.display = 'none';
            }
        }

        function showCycleReport() {
            const report = DOM.cycleReportModal;
            const { log, player1, player2, settings } = gameState;
            if (!log || log.length === 0) {
                showToast("Nenhuma atividade registrada neste ciclo para gerar um relat√≥rio.", true);
                return;
            }

            const trainedDays = new Set(log.filter(e => e.missionName.includes('Forja do Corpo') && e.ceChange > 0).map(e => e.timestamp.split('T')[0])).size;
            const studiedHours = log.filter(e => e.missionName.includes('Tomo do Saber')).reduce((sum, e) => {
                const match = e.missionName.match(/\((\d+\.?\d*)h\)/);
                return sum + (match ? parseFloat(match[1]) : 0);
            }, 0);
            
            const cycleStart = new Date(log.reduce((min, l) => new Date(l.timestamp) < min ? new Date(l.timestamp) : min, new Date()));
            const cycleEnd = new Date();
            const cycleDuration = getDayDiff(cycleEnd, cycleStart) + 1;
            const sweetDays = new Set(log.filter(e => e.missionName.includes('Feiti√ßo Doceamargo')).map(e => e.timestamp.split('T')[0])).size;
            const sweetFreeDays = cycleDuration - sweetDays;

            const secondaryMissionsCount = log.filter(e => {
                return missionDefinitions.secondary.some(m => e.missionName.includes(m.name.split(' ')[1]));
            }).length;

            const p1CE = player1.ce.toFixed(2);
            const p2CE = player2.ce.toFixed(2);
            const total = (player1.ce + player2.ce).toFixed(2);
            const treasure = (parseFloat(total) > 0 ? parseFloat(total) / settings.conversionRate : 0).toFixed(2);

            report.body.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-lg mb-6">
                    <div class="report-stat">
                        <div class="text-2xl">üèãÔ∏è</div>
                        <div class="font-bold text-xl">${trainedDays}</div>
                        <div class="text-sm text-gray-400">Dias Treinados</div>
                    </div>
                    <div class="report-stat">
                        <div class="text-2xl">üìö</div>
                        <div class="font-bold text-xl">${studiedHours.toFixed(1)}</div>
                        <div class="text-sm text-gray-400">Horas Estudadas</div>
                    </div>
                    <div class="report-stat">
                        <div class="text-2xl">üõ°Ô∏è</div>
                        <div class="font-bold text-xl">${sweetFreeDays}</div>
                        <div class="text-sm text-gray-400">Dias de Vontade</div>
                    </div>
                    <div class="report-stat">
                        <div class="text-2xl">üìú</div>
                        <div class="font-bold text-xl">${secondaryMissionsCount}</div>
                        <div class="text-sm text-gray-400">Miss√µes Cumpridas</div>
                    </div>
                </div>
                <div class="space-y-2 border-t border-gray-600 pt-4">
                    <div class="flex justify-between"><span class="font-bold text-blue-400">${player1.name}:</span><span>${p1CE} CE</span></div>
                    <div class="flex justify-between"><span class="font-bold text-red-400">${player2.name}:</span><span>${p2CE} CE</span></div>
                    <div class="flex justify-between text-xl font-bold border-t border-gray-700 pt-2 mt-2"><span class="text-yellow-400">Total:</span><span>${total} CE</span></div>
                    <div class="flex justify-between text-2xl font-bold text-green-400 mt-4"><span>Tesouro da Sincronia:</span><span>R$ ${treasure.replace('.', ',')}</span></div>
                </div>
            `;
            report.el.classList.remove('hidden');
            report.el.classList.add('flex');
        }

        function performCycleReset() {
            const p1Name = gameState.player1.name;
            const p2Name = gameState.player2.name;
            gameState = getDefaultGameState();
            gameState.player1.name = p1Name;
            gameState.player2.name = p2Name;
            saveStateToFirebase();
            showToast("Novo Ciclo Lunar iniciado!");
            closeModal(DOM.cycleReportModal.el);
        }

        // --- INICIALIZA√á√ÉO E EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            DOM = {
                loadingScreen: document.getElementById('loading-screen'),
                appContainer: document.getElementById('app-container'),
                campaignSelector: document.getElementById('campaign-selector'),
                playerSelector: document.getElementById('player-selector'),
                playerSelectionButtons: document.getElementById('player-selection-buttons'),
                loaderContainer: document.getElementById('loader-container'),
                campaignIdInput: document.getElementById('campaign-id-input'),
                joinCampaignBtn: document.getElementById('join-campaign-btn'),
                campaignIdDisplay: document.getElementById('campaign-id-display'),
                viewingPlayerDisplay: document.getElementById('viewing-player-display'),
                player1DashboardCard: document.getElementById('player1-dashboard-card'),
                player2DashboardCard: document.getElementById('player2-dashboard-card'),
                totalCE: document.getElementById('totalCE'),
                treasureValue: document.getElementById('treasureValue'),
                activityLog: document.getElementById('activity-log'),
                achievementsSection: document.getElementById('achievements-section'),
                settingsForm: document.getElementById('settings-form'),
                toast: document.getElementById('toast'),
                playerToggle: document.getElementById('player-toggle'),
                trophyPlayerToggle: document.getElementById('trophy-player-toggle'),
                trophyListContainer: document.getElementById('trophy-list-container'),
                missionListContainer: document.getElementById('mission-list-container'),
                player1Streaks: document.getElementById('player1-streaks'),
                player2Streaks: document.getElementById('player2-streaks'),
                dailyScoreTable: document.getElementById('daily-score-table'),
                dateSelector: document.getElementById('date-selector'),
                messageList: document.getElementById('message-list'),
                messageInput: document.getElementById('message-input'),
                sendMessageBtn: document.getElementById('send-message-btn'),
                messageNotificationDot: document.getElementById('message-notification-dot'),
                missionModal: {
                    el: document.getElementById('missionModal'),
                    title: document.getElementById('modalTitle'),
                    body: document.getElementById('modalBody'),
                    confirmBtn: document.getElementById('modalConfirm'),
                    cancelBtn: document.getElementById('modalCancel')
                },
                confirmModal: {
                    el: document.getElementById('confirmModal'),
                    body: document.getElementById('confirmModalBody'),
                    confirmBtn: document.getElementById('confirmModalConfirm'),
                    cancelBtn: document.getElementById('confirmModalCancel')
                },
                cycleReportModal: {
                    el: document.getElementById('cycleReportModal'),
                    body: document.getElementById('cycleReportBody'),
                    confirmBtn: document.getElementById('confirmResetBtn'),
                    closeBtn: document.getElementById('closeReportModalBtn')
                }
            };

            const savedCampaignId = localStorage.getItem('coupleLevellingCampaignId');
            if (savedCampaignId) {
                DOM.campaignIdInput.value = savedCampaignId;
                joinCampaign(savedCampaignId);
            }

            DOM.joinCampaignBtn.addEventListener('click', () => {
                const id = DOM.campaignIdInput.value.trim();
                if (id) {
                    joinCampaign(id);
                } else {
                    showToast("Por favor, insira um ID para a campanha.", true);
                }
            });

            DOM.campaignIdDisplay.addEventListener('click', () => {
                navigator.clipboard.writeText(campaignId).then(() => {
                    showToast("ID da Campanha copiado!");
                });
            });

            DOM.viewingPlayerDisplay.addEventListener('click', () => {
                DOM.loadingScreen.classList.remove('hidden');
                DOM.appContainer.classList.add('hidden');
                promptForPlayerSelection();
            });
            
            const today = new Date();
            DOM.dateSelector.value = today.toISOString().split('T')[0];
            DOM.dateSelector.addEventListener('change', () => {
                const dateParts = DOM.dateSelector.value.split('-').map(Number);
                selectedDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
            });

            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });

            document.getElementById('resetCycle').addEventListener('click', showCycleReport);
            document.getElementById('changeCampaignBtn').addEventListener('click', () => {
                if (unsubscribe) unsubscribe();
                campaignId = null;
                viewingPlayer = null;
                localStorage.removeItem('coupleLevellingCampaignId');
                DOM.appContainer.classList.add('hidden');
                DOM.loadingScreen.classList.remove('hidden');
                DOM.campaignSelector.classList.remove('hidden');
                DOM.loaderContainer.classList.add('hidden');
                DOM.campaignIdInput.value = '';
            });
            DOM.cycleReportModal.confirmBtn.addEventListener('click', performCycleReset);
            DOM.cycleReportModal.closeBtn.addEventListener('click', () => closeModal(DOM.cycleReportModal.el));
            DOM.cycleReportModal.el.querySelector('.modal-backdrop').addEventListener('click', () => closeModal(DOM.cycleReportModal.el));
            
            document.getElementById('exportCSV').addEventListener('click', exportToCSV);

            DOM.missionModal.cancelBtn.addEventListener('click', () => closeModal(DOM.missionModal.el));
            DOM.missionModal.el.querySelector('.modal-backdrop').addEventListener('click', () => closeModal(DOM.missionModal.el));
            DOM.confirmModal.cancelBtn.addEventListener('click', () => closeModal(DOM.confirmModal.el));
            DOM.confirmModal.el.querySelector('.modal-backdrop').addEventListener('click', () => closeModal(DOM.confirmModal.el));
            
            DOM.sendMessageBtn.addEventListener('click', sendMessage);
            DOM.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

    </script>

</body>
</html>
