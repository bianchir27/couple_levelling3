<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Couple Levelling: O Or√°culo da Rotina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            background-image: url('https://www.transparenttextures.com/patterns/dark-matter.png');
        }
        .font-cinzel { font-family: 'Cinzel', serif; }
        .card {
            background-color: rgba(42, 39, 39, 0.8);
            border: 1px solid #4a4a4a;
            backdrop-filter: blur(5px);
        }
        .btn { transition: all 0.2s ease-in-out; border: 1px solid #5a5a5a; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .btn-mission { background-color: #3a3a3a; }
        .btn-mission:hover { background-color: #4a4a4a; border-color: #7a7a7a; }
        .btn-veto { background-color: #6d28d9; border-color: #8b5cf6; }
        .btn-veto:disabled { background-color: #3730a3; border-color: #4f46e5; cursor: not-allowed; opacity: 0.5; }
        .ce-positive { color: #22c55e; text-shadow: 0 0 5px #22c55e; }
        .ce-negative { color: #ef4444; text-shadow: 0 0 5px #ef4444; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); }
        .tab-btn { padding: 0.5rem 1rem; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; position: relative; }
        .tab-btn.active { color: #facc15; border-bottom-color: #facc15; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .player-toggle-btn { border: 2px solid #4a4a4a; transition: all 0.3s; }
        .player-toggle-btn.active { background-color: #facc15; color: #1a1a1a; border-color: #facc15; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #22c55e; color: white; padding: 1rem 2rem; border-radius: 0.5rem; z-index: 1000; opacity: 0; transition: opacity 0.5s, transform 0.5s; }
        .toast.show { opacity: 1; transform: translate(-50%, -10px); }
        .toast.error { background-color: #ef4444; }
        .streak-card { background-color: rgba(255, 255, 255, 0.05); padding: 0.75rem; border-radius: 0.5rem; display: flex; align-items: center; justify-content: space-between; font-weight: bold; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #facc15; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .message-bubble { max-width: 75%; padding: 0.75rem; border-radius: 1rem; }
        .message-sent { background-color: #1e40af; border-bottom-right-radius: 0.25rem; }
        .message-received { background-color: #374151; border-bottom-left-radius: 0.25rem; }
        .notification-dot { position: absolute; top: 5px; right: 5px; width: 10px; height: 10px; background-color: #ef4444; border-radius: 50%; display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Tela de Carregamento / ID da Campanha -->
    <div id="loading-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-900 bg-opacity-90 backdrop-blur-sm">
        <div id="campaign-selector" class="card p-8 rounded-lg text-center">
            <h2 class="text-3xl font-cinzel text-yellow-300 mb-4">Or√°culo da Rotina</h2>
            <p class="mb-6 text-gray-400">Insira o ID da Campanha para sincronizar os dados.</p>
            <input type="text" id="campaign-id-input" placeholder="ID da Campanha" class="bg-gray-800 border border-gray-600 rounded-md p-2 w-full mb-4 text-center">
            <button id="join-campaign-btn" class="btn btn-mission bg-green-700 hover:bg-green-600 w-full mb-2 py-2">Entrar / Criar Campanha</button>
            <p class="text-xs text-gray-500">Crie um ID e compartilhe com o outro jogador.</p>
        </div>
        <div id="loader-container" class="text-center hidden">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-lg font-cinzel">Sincronizando com o grim√≥rio...</p>
        </div>
    </div>

    <div id="app-container" class="container mx-auto max-w-7xl hidden">
        <header class="text-center mb-6">
            <h1 class="text-4xl md:text-6xl font-cinzel font-bold text-yellow-300" style="text-shadow: 0 0 10px #facc15, 0 0 20px #facc15;">Couple Levelling</h1>
            <p id="campaign-id-display" class="text-sm font-mono text-gray-500 mt-2 cursor-pointer" title="Clique para copiar"></p>
        </header>

        <nav class="flex justify-center border-b border-gray-700 mb-8 text-sm md:text-base">
            <button class="tab-btn active" data-tab="dashboard">Painel</button>
            <button class="tab-btn" data-tab="missions">Miss√µes</button>
            <button class="tab-btn" data-tab="messages">Recados <span id="message-notification-dot" class="notification-dot"></span></button>
            <button class="tab-btn" data-tab="logs">Registros</button>
            <button class="tab-btn" data-tab="settings">Configura√ß√µes</button>
        </nav>

        <main>
            <!-- Conte√∫do das abas -->
            <div id="dashboard" class="tab-content active">
                <!-- Conte√∫do do Painel -->
                <section id="main-dashboard" class="card rounded-lg p-6 mb-8 grid grid-cols-1 md:grid-cols-3 gap-6 text-center shadow-lg">
                    <div>
                        <h2 id="player1NameDisplay" class="text-2xl font-cinzel text-blue-400">Her√≥i 1</h2>
                        <p id="player1CE" class="text-4xl font-bold">0 CE</p>
                        <button id="vetoPlayer1" class="btn btn-veto rounded-md px-4 py-2 mt-2 text-sm w-full">Usar Carta Veto</button>
                    </div>
                    <div class="border-t-2 md:border-t-0 md:border-x-2 border-gray-600 px-6">
                        <h2 class="text-2xl font-cinzel text-yellow-400">Tesouro da Sincronia</h2>
                        <p id="totalCE" class="text-2xl font-bold">Total: 0 CE</p>
                        <p id="treasureValue" class="text-5xl font-bold text-green-400" style="text-shadow: 0 0 8px #4ade80;">R$ 0,00</p>
                    </div>
                    <div>
                        <h2 id="player2NameDisplay" class="text-2xl font-cinzel text-red-400">Hero√≠na 2</h2>
                        <p id="player2CE" class="text-4xl font-bold">0 CE</p>
                        <button id="vetoPlayer2" class="btn btn-veto rounded-md px-4 py-2 mt-2 text-sm w-full">Usar Carta Veto</button>
                    </div>
                </section>

                <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="card rounded-lg p-6">
                        <h3 class="text-2xl font-cinzel text-center mb-4">Ofensivas de Miss√µes</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div id="player1-streaks"></div>
                            <div id="player2-streaks"></div>
                        </div>
                    </div>
                    <div class="card rounded-lg p-6">
                        <h3 class="text-2xl font-cinzel text-center mb-4">CE por Dia (√öltimos 7 Dias)</h3>
                        <div id="daily-score-table" class="overflow-x-auto"></div>
                    </div>
                </section>
                
                <section>
                    <h2 class="text-3xl font-cinzel text-center mb-4 text-yellow-300">Conquistas & Tesouros Raros</h2>
                    <div id="achievements-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                </section>
            </div>

            <div id="missions" class="tab-content">
                <!-- Conte√∫do das Miss√µes -->
                <div class="card rounded-lg p-6">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div class="flex-grow">
                            <label for="date-selector" class="font-cinzel text-yellow-400 mr-2">Data do Registro:</label>
                            <input type="date" id="date-selector" class="bg-gray-800 border border-gray-600 rounded-md p-2">
                        </div>
                        <div id="player-toggle" class="flex rounded-lg bg-gray-800 p-1"></div>
                    </div>
                    <div id="mission-list-container"></div>
                </div>
            </div>

            <div id="messages" class="tab-content">
                 <!-- Conte√∫do dos Recados -->
                 <div class="card rounded-lg p-4 flex flex-col h-[70vh]">
                    <h2 class="text-3xl font-cinzel text-center mb-4 text-gray-400">Mural de Recados</h2>
                    <div id="message-list" class="flex-grow space-y-4 overflow-y-auto p-4">
                        <!-- Mensagens ser√£o inseridas aqui -->
                    </div>
                    <div class="mt-4 flex gap-4 border-t border-gray-600 pt-4">
                        <textarea id="message-input" rows="1" placeholder="Escreva seu recado..." class="bg-gray-800 border border-gray-600 rounded-md p-2 w-full resize-none"></textarea>
                        <button id="send-message-btn" class="btn btn-mission bg-blue-700 hover:bg-blue-600 rounded-md px-6 py-2">Enviar</button>
                    </div>
                 </div>
            </div>

            <div id="logs" class="tab-content">
                <!-- Conte√∫do dos Registros -->
                <section>
                    <h2 class="text-3xl font-cinzel text-center mb-4 text-gray-400">Livro de Registros</h2>
                    <div id="activity-log" class="card rounded-lg p-4 h-[50vh] overflow-y-auto shadow-inner"></div>
                </section>
            </div>

            <div id="settings" class="tab-content">
                <!-- Conte√∫do das Configura√ß√µes -->
                <section class="card rounded-lg p-6">
                    <h2 class="text-3xl font-cinzel text-center mb-6 text-gray-400">Altar da Maleabilidade</h2>
                    <div id="settings-form"></div>
                    <div class="mt-8 border-t border-gray-600 pt-6 text-center">
                         <h3 class="text-xl font-cinzel text-yellow-500 mb-4">Controles da Campanha</h3>
                         <div class="flex flex-col md:flex-row gap-4 justify-center">
                            <button id="exportCSV" class="btn btn-mission bg-blue-800 hover:bg-blue-700 border-blue-600 text-white rounded-md px-6 py-2">Exportar para CSV</button>
                            <button id="resetCycle" class="btn btn-mission bg-red-800 hover:bg-red-700 border-red-600 text-white rounded-md px-6 py-2">Iniciar Novo Ciclo Lunar</button>
                         </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modals e Toasts -->
    <div id="missionModal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="card rounded-lg p-8 z-10 w-11/12 md:w-1/3">
            <h3 id="modalTitle" class="text-2xl font-cinzel mb-4"></h3>
            <div id="modalBody"></div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="modalCancel" class="btn btn-mission rounded-md px-4 py-2">Cancelar</button>
                <button id="modalConfirm" class="btn btn-mission bg-green-700 hover:bg-green-600 border-green-500 rounded-md px-4 py-2">Confirmar</button>
            </div>
        </div>
    </div>
    <div id="confirmModal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="card rounded-lg p-8 z-10 w-11/12 md:w-1/3 text-center">
            <h3 id="confirmModalTitle" class="text-2xl font-cinzel mb-4">Confirmar A√ß√£o</h3>
            <p id="confirmModalBody" class="text-lg mb-6"></p>
            <div class="flex justify-center gap-4 mt-6">
                <button id="confirmModalCancel" class="btn btn-mission rounded-md px-6 py-2">Cancelar</button>
                <button id="confirmModalConfirm" class="btn btn-mission bg-green-700 hover:bg-green-600 border-green-500 rounded-md px-6 py-2">Confirmar</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBW-BnhPQ83tcORZk34d0O7zU0RM8dmrog",
            authDomain: "couple-levelling.firebaseapp.com",
            projectId: "couple-levelling",
            storageBucket: "couple-levelling.appspot.com",
            messagingSenderId: "388987681031",
            appId: "1:388987681031:web:aebd2253e0fbb4c85d2da2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- CONFIGURA√á√ÉO INICIAL DO JOGO ---
        const missionDefinitions = {
            main: [
                { id: 'gym', name: 'üèãÔ∏è A Forja do Corpo', description: 'Treino na academia.', type: 'options', options: [
                    { label: 'Treino em Casal', value: 25 }, { label: 'Treino Individual', value: 20 }, { label: 'Faltou ao Treino', value: -40 }
                ], trackStreak: true},
                { id: 'study', name: 'üìö O Tomo do Saber', description: 'Sess√£o de estudos.', type: 'input', unit: 'horas', trackStreak: true },
                { id: 'chocolate', name: 'üç´ O Feiti√ßo Doceamargo', description: 'Ceder √† tenta√ß√£o.', value: -40, type: 'simple', trackStreak: true }
            ],
            secondary: [
                // ... (miss√µes secund√°rias omitidas para brevidade, mas est√£o no c√≥digo)
            ]
        };
        const achievements = [
            // ... (conquistas omitidas para brevidade, mas est√£o no c√≥digo)
        ];

        // --- ESTADO DO JOGO ---
        let gameState = {};
        let activePlayer = 'player1';
        let selectedDate = new Date();
        let campaignId = null;
        let unsubscribe;

        // --- ELEMENTOS DO DOM ---
        let DOM = {};

        function getDefaultGameState() {
            const missionSettings = {};
            const streaks = {};
            [...missionDefinitions.main, ...missionDefinitions.secondary].forEach(mission => {
                if (mission.type === 'simple') missionSettings[mission.id] = mission.value;
                else if (mission.type === 'options') missionSettings[mission.id] = mission.options.map(opt => opt.value);
                if (mission.trackStreak) {
                    streaks[mission.id] = { count: 0, lastCompletion: null };
                }
            });
            return {
                player1: { name: 'Her√≥i 1', ce: 0, vetoUsed: false, streaks: JSON.parse(JSON.stringify(streaks)) },
                player2: { name: 'Hero√≠na 2', ce: 0, vetoUsed: false, streaks: JSON.parse(JSON.stringify(streaks)) },
                log: [],
                messages: [], // Nova propriedade para mensagens
                settings: { conversionRate: 3, missions: missionSettings }
            };
        }

        // --- FUN√á√ïES DE ESTADO E UI ---
        async function saveStateToFirebase() {
            if (!campaignId) return;
            const campaignRef = doc(db, "campaigns", campaignId);
            await setDoc(campaignRef, gameState);
        }

        function updateUI() {
            if (!gameState || !gameState.player1) return;
            // ... (c√≥digo de atualiza√ß√£o da UI principal)
            renderLog();
            renderMissionsTab();
            renderStreaks();
            renderDailyScoreTable();
            renderAchievements();
            renderMessages(); // Renderiza as mensagens
        }
        
        // ... (outras fun√ß√µes de UI e l√≥gica do jogo)

        // --- NOVAS FUN√á√ïES DE MENSAGENS ---

        function renderMessages() {
            DOM.messageList.innerHTML = '';
            if (!gameState.messages || gameState.messages.length === 0) {
                DOM.messageList.innerHTML = '<p class="text-gray-500 text-center">Nenhum recado ainda.</p>';
                return;
            }

            gameState.messages.forEach(msg => {
                const isSentByMe = msg.senderId === activePlayer;
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `flex ${isSentByMe ? 'justify-end' : 'justify-start'}`;
                
                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${isSentByMe ? 'message-sent' : 'message-received'}`;
                bubble.innerHTML = `
                    <p class="font-bold text-sm ${isSentByMe ? 'text-blue-300' : 'text-yellow-300'}">${msg.senderName}</p>
                    <p class="text-white">${msg.text}</p>
                    <p class="text-xs text-gray-400 text-right mt-1">${new Date(msg.timestamp).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</p>
                `;
                messageWrapper.appendChild(bubble);
                DOM.messageList.appendChild(messageWrapper);
            });
            // Auto-scroll to bottom
            DOM.messageList.scrollTop = DOM.messageList.scrollHeight;
        }

        function sendMessage() {
            const text = DOM.messageInput.value.trim();
            if (text === '') return;

            const newMessage = {
                id: crypto.randomUUID(),
                senderId: activePlayer,
                senderName: gameState[activePlayer].name,
                text: text,
                timestamp: new Date().toISOString()
            };

            if (!gameState.messages) {
                gameState.messages = [];
            }
            gameState.messages.push(newMessage);
            saveStateToFirebase();
            DOM.messageInput.value = '';
        }

        function checkForNewMessages() {
            const lastChecked = localStorage.getItem(`lastChecked_${campaignId}`);
            if (!gameState.messages || gameState.messages.length === 0) return;

            const lastMessage = gameState.messages[gameState.messages.length - 1];
            
            // Assume there's a new message if we haven't checked before, or if the last message is new
            if (!lastChecked || new Date(lastMessage.timestamp) > new Date(lastChecked)) {
                // Find the last message NOT sent by the current active player
                const lastOtherPlayerMessage = [...gameState.messages].reverse().find(m => m.senderId !== activePlayer);
                if (lastOtherPlayerMessage && (!lastChecked || new Date(lastOtherPlayerMessage.timestamp) > new Date(lastChecked))) {
                    DOM.messageNotificationDot.style.display = 'block';
                }
            }
        }

        // --- INICIALIZA√á√ÉO E EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            DOM = {
                // ... (todos os outros elementos DOM)
                messageList: document.getElementById('message-list'),
                messageInput: document.getElementById('message-input'),
                sendMessageBtn: document.getElementById('send-message-btn'),
                messageNotificationDot: document.getElementById('message-notification-dot'),
                // ...
            };
            
            // ... (c√≥digo de inicializa√ß√£o existente)

            DOM.sendMessageBtn.addEventListener('click', sendMessage);
            DOM.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Listener para a aba de mensagens para limpar a notifica√ß√£o
            document.querySelector('button[data-tab="messages"]').addEventListener('click', () => {
                DOM.messageNotificationDot.style.display = 'none';
                localStorage.setItem(`lastChecked_${campaignId}`, new Date().toISOString());
            });
        });

        async function joinCampaign(id) {
            campaignId = id;
            localStorage.setItem('coupleLevellingCampaignId', id);
            DOM.campaignSelector.classList.add('hidden');
            DOM.loaderContainer.classList.remove('hidden');

            const campaignRef = doc(db, "campaigns", campaignId);
            
            if(unsubscribe) unsubscribe();

            unsubscribe = onSnapshot(campaignRef, (doc) => {
                const defaultState = getDefaultGameState();
                if (doc.exists()) {
                    const data = doc.data();
                    // Merge with default to ensure new properties like 'messages' exist
                    gameState = {
                        ...defaultState,
                        ...data,
                        player1: {...defaultState.player1, ...data.player1},
                        player2: {...defaultState.player2, ...data.player2},
                        settings: {...defaultState.settings, ...data.settings}
                    };
                } else {
                    showToast("Campanha n√£o encontrada. Criando uma nova...");
                    gameState = defaultState;
                    saveStateToFirebase();
                }
                checkAllStreaks();
                checkForNewMessages(); // Checa por novas mensagens
                renderSettings();
                updateUI();
                DOM.loadingScreen.classList.add('hidden');
                DOM.appContainer.classList.remove('hidden');
                DOM.campaignIdDisplay.textContent = `ID da Campanha: ${campaignId}`;
            });
        }
    </script>

</body>
</html>
